# =============================================================================
# AudiFi Backend API - Fly.io Configuration
#
# This configuration deploys the backend API to Fly.io.
# Database is managed via Neon PostgreSQL (external service).
#
# Usage:
#   - Set DATABASE_URL via `fly secrets set DATABASE_URL=<neon-connection-string>`
#   - Deploy with `flyctl deploy`
#
# IMPORTANT: DATABASE_URL must be set as a Fly.io secret before deployment.
#            Get your connection string from the Neon dashboard.
# =============================================================================

app = "audifi-api"
primary_region = "iad"

[build]
  dockerfile = "Dockerfile"

[env]
  PORT = "8080"
  NODE_ENV = "production"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = "stop"
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  [[http_service.checks]]
    grace_period = "30s"
    interval = "30s"
    method = "GET"
    path = "/api/v1/health"
    timeout = "10s"

[[vm]]
  memory = "1gb"
  cpu_kind = "shared"
  cpus = 1

# Run database migrations before starting the app
# Migrations connect to Neon PostgreSQL via DATABASE_URL secret
[deploy]
  release_command = "npm run db:migrate"
