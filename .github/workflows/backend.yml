# AudiFi Backend CI/CD Pipeline
#
# This workflow handles building, testing, and deploying the AudiFi backend
# services to Fly.io.
#
# Backend services include:
# - Master IPO / Master Contract / Dividend Contract APIs
# - V Studio session and real-time services
# - Artist Coin & liquidity integrations
# - Auth, subscriptions, and analytics
#
# Database:
# - Uses Neon PostgreSQL (not Fly Postgres)
# - Migrations run via drizzle-kit before deployment
# - DATABASE_URL secret must be configured in GitHub repository settings
#
# Deployment:
# - Staging: Deploys to audifi-api-staging on pushes to develop
# - Production: Deploys to audifi-api on pushes to main

name: Backend CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'server/**'
      - '.github/workflows/backend.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'server/**'
      - '.github/workflows/backend.yml'

# Limit permissions of GITHUB_TOKEN
permissions:
  contents: read

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Build and Test Job
  # ============================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install dependencies
        working-directory: server
        run: npm ci

      - name: Run linting
        working-directory: server
        run: npm run lint

      - name: Run type check
        working-directory: server
        run: npm run type-check

      - name: Run tests
        working-directory: server
        run: npm test

      - name: Build
        working-directory: server
        run: npm run build

      - name: Job Summary
        run: |
          echo "## ‚úÖ Backend Build & Test Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Node.js:** v${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Staging (Fly.io)
  # Uses Neon PostgreSQL for database
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://audifi-api-staging.fly.dev
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install dependencies
        working-directory: server
        run: npm ci

      - name: Run database migrations (Neon)
        working-directory: server
        run: npx drizzle-kit migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io Staging
        working-directory: server
        run: |
          if [ -z "$FLY_APP_NAME" ]; then
            echo "Error: FLY_APP_STAGING secret is required for staging deployment"
            exit 1
          fi
          flyctl deploy --remote-only --app "$FLY_APP_NAME"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_STAGING }}

      - name: Job Summary
        run: |
          echo "## üé≠ Staging Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`develop\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging (Fly.io)" >> $GITHUB_STEP_SUMMARY
          echo "**Database:** Neon PostgreSQL" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** https://audifi-api-staging.fly.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Master IPO API" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ V Studio Session API" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Auth & Subscription Services" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Artist Coin Integration" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Production (Fly.io)
  # Uses Neon PostgreSQL for database
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://audifi-api.fly.dev
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install dependencies
        working-directory: server
        run: npm ci

      - name: Run database migrations (Neon)
        working-directory: server
        run: npx drizzle-kit migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io Production
        working-directory: server
        run: |
          if [ -z "$FLY_APP_NAME" ]; then
            echo "Error: FLY_APP_PRODUCTION secret is required for production deployment"
            exit 1
          fi
          flyctl deploy --remote-only --app "$FLY_APP_NAME"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_PRODUCTION }}

      - name: Job Summary
        run: |
          echo "## üöÄ Production Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production (Fly.io)" >> $GITHUB_STEP_SUMMARY
          echo "**Database:** Neon PostgreSQL" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** https://audifi-api.fly.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Master IPO API" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Master Contract API" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Dividend Contract API" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ V Studio Session & Real-time Services" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Artist Coin & Liquidity Integration" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Auth, Subscriptions, Analytics" >> $GITHUB_STEP_SUMMARY

      - name: Notify Deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Production deployment successful"
          else
            echo "‚ùå Production deployment failed"
            # Add notification logic here (Slack, Discord, etc.)
          fi
